# Springboot web API for bulk lookup of phonenumbers on (gulesider.no, tbd....)
- Build tool : Maven
- Scraper/HTML parser : jsoup (https://jsoup.org/)
- Testcases written with Junit, MockMvc and Mockito found under `src/test/java/.*`
- docker-compose.yml to easily set up a postgres image to use with the application
- Using the JDBC API, no JPA
- No db interaction in endpoints exposed by LookupController
- PhonebookController has all endpoints that interact with a db


### Notes about integration testing
- Any integration test that tests for a specific identity bound to a number is liable to fail, as a relationship between a number and an identity is not permanent.
- As an example sometime between the implementation of `ScraperLookupTest.testGulesiderScraperCompanyLookup` and the date I am writing this (5 Nov 2024) the identity connected to the number changed:
```
  ERROR   ScraperLookupTest.testGulesiderScraperCompanyLookup:32
  expected: LookupRecord(phoneNum=41412582, identity=TELENOR NORGE AS, isCompany=true)
  but was: LookupRecord(phoneNum=41412582, identity=Talkmore, isCompany=true)
  ```
- Not because the scraper has unexpected behaviour but simply because the expected data changed.
- We would want our test to fail if the web service logic changed so that the scraper implementation no longer managed to pick out the data we are interested in.
- I have fixed the test case for now, but this can happen again with any of the numbers used in testing. So I cannot guarantee that the tests will pass when YOU run them but the assert error output will make it easy to rectify yourself.
- If it becomes a frequent issue I will change the tests to use numbers that is more likely to have a persistent identity.

## Endpoints
- [x] `GET : /api/lookup/{number}`
  - Single lookup of given number
  - [Response format 1](#1-single-lookuprecord-json)
- [x] `POST : /api/lookup/list`
  - Lookup of all the numbers in the request body
  - Request body should be a json array of numbers e.g `[12345678,24235555, ...]`
  - [Response format 2](#2-json-array-of-lookuprecords)
- [x] `POST : /api/lookup/upload`
  - Expects a 'text/plain' `.txt` file, one phone number per line
  - [Response format 2](#2-json-array-of-lookuprecords)
- [x] `POST: /api/db/lookup/save`
  - Does a single lookup and saves the result to the db
  - Expects a number in the request body
  - [Response format 3](#3-single-phonebookrecord-json) BUT record_id will be `null`, autogenerated pkey is not returned
- [x] `POST : /api/db/insert`
  - Insert a phonebook record into the database like [Response format 3](#3-single-phonebookrecord-json)
  - Leave out `record_id` and `createdAt` to have the system generate them 
  - Returns rows inserted 
- [x] `GET : /api/db/all`
  - All rows in the database
  - [Response format 4](#4-json-array-of-phonebookrecords)
- [x] `GET : /api/db/all/{number}`
  - All rows for the given number
  - [Response format 4](#4-json-array-of-phonebookrecords)
- [x] `GET : /api/db/latest/{number}`
  - Gets the most up-to-date row for the given number
  - [Response format 3](#3-single-phonebookrecord-json)
- [x] `DELETE : /api/db/delete/old/{number}`
  - Deletes records with the given number except for the most up-to-date row
  - Responds with number of rows deleted

## Response Formats

### 1) Single LookupRecord Json
  ```json
    {
      "phoneNum": "12345678",
      "identity": "Jane Doe",
      "company": false
    }  
 ``` 

### 2) Json Array of LookupRecords
```json
    [
  {
    "phoneNum": "234234",
    "identity": "John Hancock",
    "company": false
  },
  {
    "phoneNum": "22303031",
    "identity": "N/A",
    "company": false
  }
]
   ```
### 3) Single PhonebookRecord Json
```json
{
    "recordId": 2,
    "phoneNum": "33333333",
    "name": "Jane Doe",
    "createdAt": "2024-11-05T18:57:56.535+00:00",
    "company": false
}
```
### 4) Json Array of PhonebookRecords
```json
[
    {
        "recordId": 1,
        "phoneNum": "23423403",
        "name": "Some Company",
        "createdAt": "2024-11-05T18:56:05.979+00:00",
        "company": true
    },
    {
        "recordId": 2,
        "phoneNum": "87654321",
        "name": "Ola Nordmann",
        "createdAt": "2024-11-05T18:57:56.535+00:00",
        "company": false
    }
]
```

## How to run
- `git clone https://github.com/elektroluse/Ringding.git`
- `cd Ringding`
- If you want to run the test cases `./mvnw clean verify`
  - The test target uses an H2 in-memory db with postgres config, so no dependency on a real db instance  
- `docker-compose up`
  - (!) If you have a local postgres service running on the same port as defined in `docker-compose.yml`
  - You will run into issues, change the port or pause the service
  - You can still run the application and use the endpoints in `LookupController` without a running db, but you have to uncomment `spring.sql.init.continue-on-error= true` in `application.properties`
  
-  `./mvnw spring-boot:run`
   - Make API calls with Postman or write a program that sends HTTP requests to the endpoints available 

## TODO
  - Add PhonebookRecord json representation to readme
  - Refactor DTOs properly (LookupRecord should probably not be in service package)
    - Ringding and the scrapers should probably also be moved to a separate directory
    - "LookupService" with a ringding dependency would be cleaner
  - Refactor PhonebookController test
  - Create endpoint that allows for bulk lookup and save to db (?)
  - Implement sensible restrictions
    - Rate limiting
    - Validate that input string is numeric AND follows the E. 164 international standard (? maybe)
  - tbd
  - (?) DB lookup before external lookup
  - Build and run instructions
  - Usage examples
